<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WINSTON</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #1a1a1e;
    --bg-panel: #242428;
    --bg-input: #2e2e33;
    --bg-hover: #34343a;
    --border: #3a3a40;
    --border-subtle: #2e2e34;
    --text: #e4e4e8;
    --text-dim: #8e8e96;
    --text-muted: #5a5a62;
    --blue: #4a9eff;
    --green: #4ade80;
    --amber: #fbbf24;
    --purple: #a78bfa;
    --red: #f87171;
    font-family: 'Inter', -apple-system, system-ui, sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  /* ===== Status Bar ===== */
  .status-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    height: 48px;
    min-height: 48px;
    background: var(--bg-panel);
    border-bottom: 1px solid var(--border);
    gap: 16px;
    z-index: 10;
  }
  .status-left {
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 0;
  }
  .status-dot {
    width: 14px;
    height: 14px;
    min-width: 14px;
    border-radius: 50%;
    background: var(--text-muted);
    transition: background 0.5s, box-shadow 0.5s;
  }
  .status-dot.idle {
    background: var(--green);
    box-shadow: 0 0 8px rgba(74, 222, 128, 0.5);
  }
  .status-dot.online {
    background: var(--green);
    box-shadow: 0 0 8px rgba(74, 222, 128, 0.5);
  }
  .status-dot.listening {
    background: var(--green);
    box-shadow: 0 0 12px rgba(74, 222, 128, 0.6);
    animation: pulse 0.8s ease-in-out infinite;
  }
  .status-dot.thinking {
    background: var(--amber);
    box-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
    animation: pulse 1.5s ease-in-out infinite;
  }
  .status-dot.speaking {
    background: var(--blue);
    box-shadow: 0 0 8px rgba(74, 158, 255, 0.5);
  }
  .status-dot.initializing {
    background: var(--text-muted);
    animation: pulse 2s ease-in-out infinite;
  }
  .status-dot.error {
    background: var(--red);
    box-shadow: 0 0 8px rgba(248, 113, 113, 0.5);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.85); }
  }

  .status-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    transition: color 0.5s;
  }
  .logo {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--text-dim);
  }
  .status-center {
    flex: 1;
    max-width: 320px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
  }
  .cost-text {
    font-size: 10px;
    font-weight: 500;
    color: var(--text-dim);
    font-variant-numeric: tabular-nums;
  }
  .cost-track {
    width: 100%;
    height: 3px;
    background: var(--bg-input);
    border-radius: 2px;
    overflow: hidden;
  }
  .cost-fill {
    height: 100%;
    width: 0%;
    background: var(--blue);
    border-radius: 2px;
    transition: width 0.5s ease, background 0.5s ease;
  }
  .cost-fill.warn { background: var(--amber); }
  .cost-fill.danger { background: var(--red); }

  .status-right {
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .uptime {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-dim);
    font-variant-numeric: tabular-nums;
  }
  .modules {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .module-dot {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
  }
  .module-dot .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
    transition: background 0.5s;
  }
  .module-dot .dot.online { background: var(--green); }
  .module-dot .dot.loading {
    background: var(--amber);
    animation: pulse 1s ease-in-out infinite;
  }
  .module-dot .dot.error { background: var(--red); }

  .talk-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 14px;
    border-radius: 14px;
    background: var(--blue);
    color: #fff;
    border: none;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }
  .talk-btn:hover { background: #3a8eef; }
  .talk-btn:active { transform: scale(0.97); }
  .talk-btn svg { width: 12px; height: 12px; }

  /* ===== Main Content ===== */
  .main-content {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 360px;
    overflow: hidden;
  }

  /* ===== Conversation Panel ===== */
  .conversation-panel {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    overflow: hidden;
  }
  .conv-header {
    padding: 12px 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border-subtle);
  }
  .conversation {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    padding: 10px 14px;
    font-size: 13px;
    line-height: 1.5;
    max-width: 80%;
    word-wrap: break-word;
    position: relative;
  }
  .msg.user {
    align-self: flex-end;
    background: rgba(74, 158, 255, 0.15);
    color: var(--text);
    border-radius: 16px 16px 4px 16px;
    border: 1px solid rgba(74, 158, 255, 0.2);
  }
  .msg.winston {
    align-self: flex-start;
    background: var(--bg-input);
    color: var(--text);
    border-radius: 16px 16px 16px 4px;
    border: 1px solid var(--border-subtle);
  }
  .msg.proactive {
    align-self: flex-start;
    background: rgba(167, 139, 250, 0.08);
    color: var(--text);
    border-radius: 16px 16px 16px 4px;
    border: 1px solid rgba(167, 139, 250, 0.15);
    border-left: 3px solid var(--purple);
  }
  .msg.agent {
    align-self: flex-start;
    background: rgba(251, 191, 36, 0.06);
    color: var(--text);
    border-radius: 16px 16px 16px 4px;
    border: 1px solid rgba(251, 191, 36, 0.12);
    border-left: 3px solid var(--amber);
  }
  .msg-footer {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 5px;
  }
  .msg-time {
    font-size: 10px;
    color: var(--text-muted);
  }
  .msg-tag {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1px 6px;
    border-radius: 4px;
  }
  .msg-tag.haiku {
    background: rgba(74, 158, 255, 0.12);
    color: var(--blue);
  }
  .msg-tag.opus {
    background: rgba(251, 191, 36, 0.12);
    color: var(--amber);
  }
  .empty-state {
    color: var(--text-muted);
    font-size: 13px;
    text-align: center;
    padding: 40px 20px;
  }

  /* ===== Sidebar ===== */
  .sidebar {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-panel);
  }

  /* Live View */
  .live-view {
    padding: 14px;
    border-bottom: 1px solid var(--border);
  }
  .section-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 10px;
  }
  .camera-frame {
    width: 100%;
    border-radius: 8px;
    background: var(--bg-input);
    aspect-ratio: 16/9;
    object-fit: cover;
    display: block;
  }
  .audio-section {
    margin-top: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .audio-label {
    font-size: 10px;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 40px;
  }
  .audio-track {
    flex: 1;
    height: 4px;
    background: var(--bg-input);
    border-radius: 2px;
    overflow: hidden;
  }
  .audio-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--green), var(--blue));
    border-radius: 2px;
    transition: width 0.08s linear;
  }
  .listen-state {
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .listen-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-muted);
    transition: background 0.3s;
  }
  .listen-dot.active { background: var(--green); }
  .listen-label {
    font-size: 11px;
    color: var(--text-dim);
    font-weight: 500;
  }

  /* Latency Stats */
  .latency-section {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-subtle);
  }
  .latency-row {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    padding: 2px 0;
  }
  .latency-row .label { color: var(--text-muted); }
  .latency-row .value { color: var(--text-dim); font-weight: 500; font-variant-numeric: tabular-nums; }

  /* Tabs */
  .tab-bar {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--bg-panel);
  }
  .tab {
    flex: 1;
    padding: 10px 0;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    text-align: center;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .tab:hover { color: var(--text-dim); }
  .tab.active {
    color: var(--blue);
    border-bottom-color: var(--blue);
  }
  .tab-content {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding: 14px;
  }
  .tab-content.active { display: block; }

  /* Memory Tab */
  .stat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 14px;
  }
  .stat-card {
    background: var(--bg-input);
    padding: 10px 12px;
    border-radius: 8px;
  }
  .stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    font-variant-numeric: tabular-nums;
  }
  .stat-label {
    font-size: 10px;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }
  .fact-group {
    margin-bottom: 10px;
  }
  .fact-tag {
    display: inline-block;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 2px 7px;
    border-radius: 4px;
    margin-bottom: 6px;
  }
  .fact-tag.personal { background: rgba(74, 158, 255, 0.12); color: var(--blue); }
  .fact-tag.equipment { background: rgba(74, 222, 128, 0.12); color: var(--green); }
  .fact-tag.project { background: rgba(167, 139, 250, 0.12); color: var(--purple); }
  .fact-tag.workshop { background: rgba(251, 191, 36, 0.12); color: var(--amber); }
  .fact-tag.safety { background: rgba(248, 113, 113, 0.12); color: var(--red); }
  .fact-tag.other { background: rgba(142, 142, 150, 0.12); color: var(--text-dim); }
  .fact-item {
    font-size: 12px;
    color: var(--text-dim);
    padding: 3px 0 3px 10px;
    border-left: 2px solid var(--border-subtle);
    line-height: 1.4;
  }
  .sub-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin: 14px 0 8px;
  }
  .obs-item {
    font-size: 12px;
    color: var(--text-dim);
    line-height: 1.5;
    margin-bottom: 8px;
    padding-left: 10px;
    border-left: 2px solid var(--border-subtle);
  }
  .obs-time {
    font-size: 10px;
    color: var(--text-muted);
    font-weight: 500;
  }

  /* Tasks Tab */
  .agent-task {
    padding: 12px;
    border-left: 3px solid var(--blue);
    background: var(--bg-input);
    border-radius: 8px;
    font-size: 12px;
    margin-bottom: 8px;
  }
  .agent-task.running {
    border-left-color: var(--amber);
    animation: pulse-border 2s ease-in-out infinite;
  }
  .agent-task.failed { border-left-color: var(--red); }
  .agent-task.completed { border-left-color: var(--green); }
  .task-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .task-status {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 1px;
  }
  .task-status.running { color: var(--amber); }
  .task-status.completed { color: var(--green); }
  .task-status.failed { color: var(--red); }
  .task-time {
    font-size: 10px;
    color: var(--text-muted);
  }
  .task-query {
    color: var(--text-dim);
    margin: 4px 0;
    line-height: 1.4;
  }
  .task-result {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid var(--border-subtle);
    color: var(--text);
    white-space: pre-wrap;
    max-height: 100px;
    overflow-y: auto;
    font-size: 11px;
    line-height: 1.5;
  }
  .task-result.expanded { max-height: none; }
  .task-expand {
    font-size: 10px;
    color: var(--blue);
    cursor: pointer;
    margin-top: 4px;
    display: inline-block;
  }
  .task-expand:hover { text-decoration: underline; }

  @keyframes pulse-border {
    0%, 100% { border-left-color: var(--amber); }
    50% { border-left-color: rgba(251, 191, 36, 0.3); }
  }

  /* Notes Tab */
  .add-note-form {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }
  .add-note-form input {
    flex: 1;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    color: var(--text);
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }
  .add-note-form input::placeholder { color: var(--text-muted); }
  .add-note-form input:focus { border-color: var(--blue); }
  .add-note-form button {
    background: var(--blue);
    color: #fff;
    border: none;
    border-radius: 8px;
    width: 34px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    font-family: inherit;
  }
  .add-note-form button:hover { background: #3a8eef; }
  .note-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 12px;
    background: var(--bg-input);
    border-radius: 8px;
    margin-bottom: 6px;
    font-size: 13px;
  }
  .note-item.done .note-text {
    text-decoration: line-through;
    color: var(--text-muted);
  }
  .note-check {
    cursor: pointer;
    width: 18px;
    height: 18px;
    min-width: 18px;
    border: 2px solid var(--border);
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    margin-top: 1px;
  }
  .note-check:hover { border-color: var(--blue); }
  .note-check.checked {
    background: var(--green);
    border-color: var(--green);
  }
  .note-check.checked::after {
    content: '\2713';
    color: #1a1a1e;
    font-size: 11px;
    font-weight: 700;
  }
  .note-text { flex: 1; line-height: 1.4; color: var(--text); }
  .note-meta { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
  .note-delete {
    cursor: pointer;
    color: var(--text-muted);
    font-size: 16px;
    line-height: 1;
    opacity: 0.3;
    transition: all 0.2s ease;
    padding: 0 2px;
  }
  .note-delete:hover { opacity: 1; color: var(--red); }

  /* Connection status */
  .conn-status {
    position: fixed;
    bottom: 12px;
    right: 12px;
    font-size: 10px;
    font-weight: 600;
    padding: 5px 12px;
    border-radius: 12px;
    background: var(--bg-panel);
    border: 1px solid var(--border);
    color: var(--text-muted);
    z-index: 100;
    transition: all 0.3s;
  }
  .conn-status.connected { border-color: var(--green); color: var(--green); }
  .conn-status.reconnecting { border-color: var(--amber); color: var(--amber); }
  .conn-status.disconnected { border-color: var(--red); color: var(--red); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* ===== Responsive ===== */
  @media (max-width: 768px) {
    .status-bar {
      padding: 0 12px;
      gap: 8px;
    }
    .logo { display: none; }
    .status-center { max-width: 160px; }
    .modules { display: none; }

    .main-content {
      grid-template-columns: 1fr;
      overflow-y: auto;
    }
    .conversation-panel {
      border-right: none;
      min-height: 50vh;
    }
    .sidebar {
      border-top: 1px solid var(--border);
    }
  }
</style>
</head>
<body>

<div class="app">
  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-left">
      <div class="status-dot" id="status-dot"></div>
      <span class="status-label" id="status-label">INITIALIZING</span>
      <span class="logo">WINSTON</span>
    </div>
    <div class="status-center">
      <span class="cost-text" id="cost-text">$0.00 / $2.00</span>
      <div class="cost-track">
        <div class="cost-fill" id="cost-fill"></div>
      </div>
    </div>
    <div class="status-right">
      <span class="uptime" id="uptime">00:00:00</span>
      <div class="modules" id="modules">
        <div class="module-dot"><span class="dot" id="dot-camera"></span>CAM</div>
        <div class="module-dot"><span class="dot" id="dot-audio"></span>MIC</div>
        <div class="module-dot"><span class="dot" id="dot-memory"></span>MEM</div>
        <div class="module-dot"><span class="dot" id="dot-llm"></span>AI</div>
        <div class="module-dot"><span class="dot" id="dot-tts"></span>TTS</div>
      </div>
      <button class="talk-btn" id="talk-btn" onclick="dashboard.triggerListen()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
        Talk
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Conversation -->
    <div class="conversation-panel">
      <div class="conv-header">Conversation</div>
      <div class="conversation" id="conversation">
        <div class="empty-state">Speak or press Talk to start a conversation</div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Live View -->
      <div class="live-view">
        <div class="section-label">Live View</div>
        <img class="camera-frame" id="camera-frame" alt="Camera">
        <div class="audio-section">
          <span class="audio-label">Audio</span>
          <div class="audio-track">
            <div class="audio-fill" id="audio-fill"></div>
          </div>
        </div>
        <div class="listen-state">
          <div class="listen-dot" id="listen-dot"></div>
          <span class="listen-label" id="listen-label">Always-listen: idle</span>
        </div>
        <div class="latency-section" id="latency-section" style="display:none">
          <div class="section-label" style="margin-bottom:4px">Latency</div>
          <div id="latency-stats"></div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tab-bar">
        <div class="tab active" data-tab="memory">Memory</div>
        <div class="tab" data-tab="tasks">Tasks</div>
        <div class="tab" data-tab="notes">Notes</div>
      </div>

      <!-- Memory Tab -->
      <div class="tab-content active" id="tab-memory">
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-value" id="mem-episodes">0</div>
            <div class="stat-label">Episodes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="mem-facts">0</div>
            <div class="stat-label">Facts</div>
          </div>
        </div>
        <div id="facts-list"></div>
        <div class="sub-label">Recent Observations</div>
        <div id="observations"><span class="empty-state" style="padding:10px;">No observations yet</span></div>
      </div>

      <!-- Tasks Tab -->
      <div class="tab-content" id="tab-tasks">
        <div id="agent-tasks">
          <span class="empty-state">No investigations yet</span>
        </div>
      </div>

      <!-- Notes Tab -->
      <div class="tab-content" id="tab-notes">
        <form class="add-note-form" id="add-note-form">
          <input type="text" placeholder="Add a note..." id="note-input" autocomplete="off">
          <button type="submit">+</button>
        </form>
        <div id="notes-list">
          <span class="empty-state">No notes yet</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="conn-status disconnected" id="conn-status">DISCONNECTED</div>

<script>
class Dashboard {
  constructor() {
    this.ws = null;
    this.reconnectDelay = 1000;
    this.maxReconnectDelay = 30000;
    this.lastConversationLen = 0;
    this.activeTab = 'memory';
    this.factsLoaded = false;
    this._lastTasks = [];
    this._lastNotes = [];
    this._lastObs = [];

    this.el = {
      statusDot: document.getElementById('status-dot'),
      statusLabel: document.getElementById('status-label'),
      costText: document.getElementById('cost-text'),
      costFill: document.getElementById('cost-fill'),
      uptime: document.getElementById('uptime'),
      conversation: document.getElementById('conversation'),
      cameraFrame: document.getElementById('camera-frame'),
      audioFill: document.getElementById('audio-fill'),
      listenDot: document.getElementById('listen-dot'),
      listenLabel: document.getElementById('listen-label'),
      latencySection: document.getElementById('latency-section'),
      latencyStats: document.getElementById('latency-stats'),
      memEpisodes: document.getElementById('mem-episodes'),
      memFacts: document.getElementById('mem-facts'),
      factsList: document.getElementById('facts-list'),
      observations: document.getElementById('observations'),
      agentTasks: document.getElementById('agent-tasks'),
      notesList: document.getElementById('notes-list'),
      connStatus: document.getElementById('conn-status'),
      talkBtn: document.getElementById('talk-btn'),
      addNoteForm: document.getElementById('add-note-form'),
      noteInput: document.getElementById('note-input'),
    };

    this.dots = {};
    for (const m of ['camera', 'audio', 'memory', 'llm', 'tts']) {
      this.dots[m] = document.getElementById('dot-' + m);
    }

    this.connect();
    this.setupTabs();
    this.setupNoteForm();
    this.startCameraRefresh();
    this.loadFacts();
  }

  // ===== WebSocket with exponential backoff =====
  connect() {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    this.ws = new WebSocket(`${proto}://${location.host}/ws`);

    this.ws.onopen = () => {
      this.reconnectDelay = 1000;
      this.el.connStatus.textContent = 'CONNECTED';
      this.el.connStatus.className = 'conn-status connected';
    };

    this.ws.onclose = () => {
      this.el.connStatus.textContent = 'RECONNECTING...';
      this.el.connStatus.className = 'conn-status reconnecting';
      setTimeout(() => this.connect(), this.reconnectDelay);
      this.reconnectDelay = Math.min(this.reconnectDelay * 2, this.maxReconnectDelay);
    };

    this.ws.onerror = () => {};

    this.ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === 'state') this.handleState(msg.data);
      if (msg.type === 'audio') this.handleAudio(msg.data);
    };
  }

  // ===== Full state update =====
  handleState(data) {
    // Status dot + label
    this.el.statusDot.className = 'status-dot ' + (data.status || 'initializing');
    this.el.statusLabel.textContent = (data.status || 'initializing').toUpperCase();

    // Uptime
    const secs = Math.floor(data.uptime || 0);
    const hh = String(Math.floor(secs / 3600)).padStart(2, '0');
    const mm = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
    const ss = String(secs % 60).padStart(2, '0');
    this.el.uptime.textContent = `${hh}:${mm}:${ss}`;

    // Module dots
    for (const [name, info] of Object.entries(data.modules || {})) {
      const dot = this.dots[name];
      if (dot) dot.className = 'dot ' + info.status;
    }

    // Cost
    const cost = data.costToday || 0;
    const budget = data.budgetMax || 2.0;
    this.el.costText.textContent = `$${cost.toFixed(2)} / $${budget.toFixed(2)}`;
    const costPct = (cost / budget) * 100;
    this.el.costFill.style.width = Math.min(100, costPct) + '%';
    this.el.costFill.className = 'cost-fill' + (costPct > 90 ? ' danger' : costPct > 75 ? ' warn' : '');

    // Audio level
    this.el.audioFill.style.width = Math.min(100, (data.audioLevel || 0) * 500) + '%';

    // Always-listen state
    const listenState = data.alwaysListenState || 'disabled';
    const isActive = listenState !== 'disabled' && listenState !== 'idle';
    this.el.listenDot.className = 'listen-dot' + (isActive ? ' active' : '');
    this.el.listenLabel.textContent = 'Always-listen: ' + listenState;

    // Latency stats (if available)
    if (data.latencyStats && data.latencyStats.interaction_count > 0) {
      this.el.latencySection.style.display = '';
      const ls = data.latencyStats;
      this.el.latencyStats.innerHTML = `
        <div class="latency-row"><span class="label">Avg total</span><span class="value">${Math.round(ls.avg_total_ms || 0)}ms</span></div>
        <div class="latency-row"><span class="label">Avg STT</span><span class="value">${Math.round(ls.avg_stt_ms || 0)}ms</span></div>
        <div class="latency-row"><span class="label">Avg LLM</span><span class="value">${Math.round(ls.avg_llm_ms || 0)}ms</span></div>
        <div class="latency-row"><span class="label">Avg TTS</span><span class="value">${Math.round(ls.avg_tts_ms || 0)}ms</span></div>
        <div class="latency-row"><span class="label">Interactions</span><span class="value">${ls.interaction_count || 0}</span></div>
      `;
    }

    // Memory stats
    this.el.memEpisodes.textContent = data.memoryEpisodes || 0;
    this.el.memFacts.textContent = data.memoryFacts || 0;

    // Conversation
    if (data.conversation && data.conversation.length !== this.lastConversationLen) {
      this.lastConversationLen = data.conversation.length;
      if (data.conversation.length === 0) {
        this.el.conversation.innerHTML = '<div class="empty-state">Speak or press Talk to start a conversation</div>';
      } else {
        this.el.conversation.innerHTML = data.conversation.map(m => {
          const role = m.role || 'winston';
          const roleConfig = {
            user:      { cls: 'user',      tag: '' },
            winston:   { cls: 'winston',   tag: '<span class="msg-tag haiku">Haiku</span>' },
            proactive: { cls: 'proactive', tag: '<span class="msg-tag haiku">Haiku</span>' },
            agent:     { cls: 'agent',     tag: '<span class="msg-tag opus">Opus</span>' },
          };
          const cfg = roleConfig[role] || roleConfig.winston;
          return `<div class="msg ${cfg.cls}">${this.esc(m.text)}<div class="msg-footer"><span class="msg-time">${m.timestamp || ''}</span>${cfg.tag}</div></div>`;
        }).join('');
        this.el.conversation.scrollTop = this.el.conversation.scrollHeight;
      }
    }

    // Cache data for tab switches
    this._lastObs = (data.observations || []).slice(-5);
    this._lastTasks = data.agentTasks || [];
    this._lastNotes = data.notes || [];

    // Render active tab content
    if (this.activeTab === 'memory') {
      this.el.observations.innerHTML = this._lastObs.length
        ? this._lastObs.map(o => `<div class="obs-item"><span class="obs-time">${o.timestamp}</span> ${this.esc(o.description)}</div>`).join('')
        : '<span class="empty-state" style="padding:10px;">No observations yet</span>';
    }
    if (this.activeTab === 'tasks') {
      this.renderTasks(this._lastTasks);
    }
    if (this.activeTab === 'notes') {
      this.renderNotes(this._lastNotes);
    }
  }

  handleAudio(data) {
    this.el.audioFill.style.width = Math.min(100, (data.audioLevel || 0) * 500) + '%';
  }

  // ===== Agent Tasks =====
  renderTasks(tasks) {
    if (tasks.length > 0) {
      this.el.agentTasks.innerHTML = tasks.slice(-10).reverse().map(t => {
        const resultHtml = t.result
          ? `<div class="task-result">${this.esc(t.result.substring(0, 500))}</div>${t.result.length > 500 ? '<span class="task-expand" onclick="this.previousElementSibling.classList.toggle(\'expanded\');this.textContent=this.previousElementSibling.classList.contains(\'expanded\')?\'Show less\':\'Show more\'">Show more</span>' : ''}`
          : (t.status === 'running' ? '<div class="task-result" style="color:var(--amber)">Investigating...</div>' : '');
        return `<div class="agent-task ${t.status}">
          <div class="task-header"><span class="task-status ${t.status}">${t.status}</span><span class="task-time">${t.created_at || ''}</span></div>
          <div class="task-query">${this.esc(t.query || '')}</div>
          ${resultHtml}
        </div>`;
      }).join('');
    } else {
      this.el.agentTasks.innerHTML = '<span class="empty-state">No investigations yet</span>';
    }
  }

  // ===== Notes =====
  renderNotes(notes) {
    if (notes.length > 0) {
      this.el.notesList.innerHTML = notes.map(n => `
        <div class="note-item ${n.done ? 'done' : ''}" data-id="${n.id}">
          <div class="note-check ${n.done ? 'checked' : ''}" onclick="dashboard.toggleNote('${n.id}')"></div>
          <div style="flex:1">
            <div class="note-text">${this.esc(n.text)}</div>
            <div class="note-meta">${n.created_at ? new Date(n.created_at).toLocaleString() : ''}</div>
          </div>
          <div class="note-delete" onclick="dashboard.deleteNote('${n.id}')">&times;</div>
        </div>
      `).join('');
    } else {
      this.el.notesList.innerHTML = '<span class="empty-state">No notes yet</span>';
    }
  }

  toggleNote(id) {
    fetch(`/api/notes/${id}/toggle`, { method: 'POST' }).catch(e => console.error('Toggle failed:', e));
  }

  deleteNote(id) {
    fetch(`/api/notes/${id}`, { method: 'DELETE' }).catch(e => console.error('Delete failed:', e));
  }

  setupNoteForm() {
    this.el.addNoteForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = this.el.noteInput.value.trim();
      if (!text) return;
      this.el.noteInput.value = '';
      fetch('/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      }).catch(err => console.error('Create note failed:', err));
    });
  }

  // ===== Tabs =====
  setupTabs() {
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelector('.tab.active').classList.remove('active');
        document.querySelector('.tab-content.active').classList.remove('active');
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        this.activeTab = tab.dataset.tab;

        // Render cached data for newly active tab
        if (tab.dataset.tab === 'memory') {
          if (!this.factsLoaded) this.loadFacts();
          this.el.observations.innerHTML = this._lastObs.length
            ? this._lastObs.map(o => `<div class="obs-item"><span class="obs-time">${o.timestamp}</span> ${this.esc(o.description)}</div>`).join('')
            : '<span class="empty-state" style="padding:10px;">No observations yet</span>';
        }
        if (tab.dataset.tab === 'tasks') this.renderTasks(this._lastTasks);
        if (tab.dataset.tab === 'notes') this.renderNotes(this._lastNotes);
      });
    });
  }

  // ===== Camera (periodic snapshot) =====
  startCameraRefresh() {
    const refresh = () => {
      this.el.cameraFrame.src = '/api/camera/frame?t=' + Date.now();
    };
    refresh();
    setInterval(refresh, 3000);
  }

  // ===== Structured Facts =====
  loadFacts() {
    fetch('/api/facts/structured')
      .then(r => r.json())
      .then(data => {
        this.factsLoaded = true;
        const facts = data.facts || [];
        if (!facts.length) {
          this.el.factsList.innerHTML = '<span class="empty-state" style="padding:10px;">No facts stored yet</span>';
          return;
        }
        const grouped = {};
        facts.forEach(f => {
          const cat = f.category || 'other';
          (grouped[cat] = grouped[cat] || []).push(f);
        });
        let html = '';
        for (const [cat, items] of Object.entries(grouped).sort()) {
          html += `<div class="fact-group"><span class="fact-tag ${cat}">${cat}</span>`;
          items.forEach(f => {
            html += `<div class="fact-item">${this.esc(f.entity || '')}: ${this.esc(f.attribute || '')} = ${this.esc(String(f.value || ''))}</div>`;
          });
          html += '</div>';
        }
        this.el.factsList.innerHTML = html;
      })
      .catch(() => {
        this.el.factsList.innerHTML = '<span class="empty-state" style="padding:10px;">Could not load facts</span>';
      });
  }

  // ===== Talk Button =====
  triggerListen() {
    this.el.talkBtn.style.opacity = '0.5';
    fetch('/api/listen', { method: 'POST' })
      .then(r => r.json())
      .then(() => { this.el.talkBtn.style.opacity = '1'; })
      .catch(() => { this.el.talkBtn.style.opacity = '1'; });
  }

  // ===== XSS-safe HTML escaping =====
  esc(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
}

let dashboard;
window.addEventListener('DOMContentLoaded', () => { dashboard = new Dashboard(); });
</script>
</body>
</html>
